---
import { type CollectionEntry, getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";


import InfoBar from "@components/InfoBar.astro";
import XiuhcoatlDivider from "@components/XiuhcoatlDivider.astro";
import TechChip from "@components/bits/TechChip.astro";
import FigImage from "@components/bits/FigImage.astro";
import SectionHeader from "@components/bits/SectionHeader.astro";
import RepositoryCard from "@components/bits/RepositoryCard.astro";
import { getLocalizedPath, t, type Locale } from "@lib/i18n";

import { BITS_CONTENT } from "src/data/bits-content";

export async function getStaticPaths() {
  const posts = (await getCollection("bits"))
    .filter(post => !post.data.draft);
  
  const paths = [];
  for (const post of posts) {
    const [lang, ...slugParts] = post.slug.split('/');
    const cleanSlug = slugParts.join('/');
    paths.push({
      params: { lang, slug: cleanSlug },
      props: post,
    });
  }
  return paths;
}

type Props = CollectionEntry<"bits">;

const post = Astro.props;
const { Content } = await post.render();
const { lang } = Astro.params as { lang: Locale };
const bitsContent = BITS_CONTENT[lang];
---

<PageLayout title={post.data.title} description={post.data.description} lang={lang} className="flex-grow">

    <SectionHeader title={post.data.title} subtitle={post.data.description} />

    <InfoBar 
      items={[
        { label: 'DATE', value: post.data.date.getFullYear().toString() },
        { label: 'TYPE', value: post.data.type?.toUpperCase() || 'PROJECT' },
        { label: 'STATUS', value: post.data.status.toUpperCase() }
      ]}
    />

    <article class="w-full space-y-12">
      
      <FigImage images={post.data.images} alt={post.data.title} />

      <div class="prose prose-invert prose-lg max-w-none 
        prose-headings:font-bold prose-headings:uppercase prose-headings:text-white prose-headings:font-mono
        prose-p:text-[#D4D4D4] prose-p:font-body prose-p:text-base prose-p:leading-relaxed
        prose-a:text-[#25BCC0] prose-a:no-underline hover:prose-a:underline
        prose-strong:text-white
        prose-code:text-[#25BCC0] prose-code:font-mono prose-code:text-sm
        prose-li:text-[#D4D4D4] prose-li:font-body marker:prose-li:text-[#25BCC0]">
        
        <Content />
        <hr />
      </div>
      <div class="w-full">
         <h2 class="section-title">{bitsContent.toolkit}</h2>
         <div class="flex flex-wrap gap-3 mt-6">
            {post.data.stack.map((tech: string) => (
                <TechChip text={tech} />
            ))}
         </div>
      </div>

      {post.data.repository_url && (
        <RepositoryCard title={bitsContent.repository} url={post.data.repository_url} />
      )}
    </article>
</PageLayout>

<style is:global>
  /* Global typography overrides for the prose content */
  
  /* 1. Remove backticks from inline code - Forceful override */
  .prose code::before,
  .prose code::after {
    content: none !important;
    display: none !important;
  }

  /* 2. Ensure list items match body text size and font */
  .prose ul > li, 
  .prose ol > li {
    font-family: 'Montserrat', sans-serif !important;
    font-size: 1rem !important;
    color: #D4D4D4 !important;
    line-height: 1.75 !important;
    margin-top: 0.5em !important;
    margin-bottom: 0.5em !important;
  }
  
  /* Ensure paragraphs inside lists also inherit correct styles */
  .prose li p {
    font-family: 'Montserrat', sans-serif !important;
    font-size: 1rem !important;
    color: #D4D4D4 !important;
    margin: 0 !important;
  }

  /* 3. Enforce link styling: Turquoise, no underline default, solid technical underline hover */
  .prose a {
    color: #25BCC0 !important;
    text-decoration: none !important;
    transition: all 0.2s ease-in-out;
  }
  .prose a:hover {
    text-decoration: none !important;
    opacity: 0.8;
  }

  /* 4. Ensure strong tags are white */
  .prose strong {
    color: white !important;
    font-weight: 700 !important;
  }
</style>

<style>
  article {
    counter-reset: section;
  }
  
  /* Target both markdown H2 and manual .section-title class */
  /* Target both markdown H2 and manual .section-title class globally */
  :global(.prose h2), :global(.section-title) {
    @apply text-xl text-[#25BCC0] font-mono tracking-widest mb-6 mt-12 uppercase flex items-center gap-2;
  }
  
  :global(.prose h2::before), :global(.section-title::before) {
    counter-increment: section;
    content: "0" counter(section) " // ";
    @apply text-[#25BCC0] opacity-100;
  }

  /* Target markdown H3 for subsections */
  :global(.prose h3) {
      @apply text-lg text-white font-bold tracking-wide uppercase mt-8 mb-4;
  }

  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: #1a1a1a; }
  ::-webkit-scrollbar-thumb { background: #333; }
  ::-webkit-scrollbar-thumb:hover { background: #25BCC0; }
</style>
