---
import { getCollection } from "astro:content";
import PageLayout from "@layouts/PageLayout.astro";
import { dateRange } from "@lib/utils";
import { type Locale } from "@lib/i18n";
import Hero from "@components/cv/Hero.astro";

import TimelineItem from "@components/cv/TimelineItem.astro";
import AcademicOrigin from "@components/cv/AcademicOrigin.astro";
import SkillMatrix from "@components/cv/SkillMatrix.astro";
import { CV_CONTENT } from "@data/cv-content";

import { getLangStaticPaths } from "@lib/static-paths";

export const getStaticPaths = getLangStaticPaths;

const { lang } = Astro.params as { lang: Locale };
const content = CV_CONTENT[lang];

const allWork = (await getCollection("work"))
  .filter(item => item.slug.startsWith(`${lang}/`))
  .sort((a, b) => new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf());

const work = await Promise.all(
  allWork.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  })
);

const allEducation = (await getCollection("education"))
  .filter(item => item.slug.startsWith(`${lang}/`))
  .sort((a, b) => new Date(b.data.dateStart).valueOf() - new Date(a.data.dateStart).valueOf());

const education = await Promise.all(
  allEducation.map(async (item) => {
    const { Content } = await item.render();
    return { ...item, Content };
  })
);

const bits = (await getCollection("bits")).filter(item => item.slug.startsWith(`${lang}/`));
const atoms = (await getCollection("atoms")).filter(item => item.slug.startsWith(`${lang}/`));
const allStacks = [...bits, ...atoms]
  .filter(item => !item.data.draft)
  .flatMap(item => item.data.stack || []);
const uniqueSkills = [...new Set(allStacks)].sort();

---

<PageLayout title="CV" description="Curriculum Vitae" lang={lang}>


    <Hero name={content.hero.name} subtitle={content.hero.subtitle} />

    <!-- Timeline Grid -->
    <div class="w-full grid grid-cols-[50px_1fr] md:grid-cols-[1fr_80px_1fr] gap-x-0 relative">

      <!-- Central spine line -->
      <div class="absolute top-0 bottom-0 left-[24px] md:left-1/2 md:-translate-x-1/2 w-[2px] bg-border-dark z-0 h-full"></div>


      <!-- Work Entries -->
      {work.map((entry, index) => (
        <TimelineItem
            year={index === 0 ? (lang === 'es' ? 'HOY' : 'NOW') : dateRange(entry.data.dateStart, entry.data.dateEnd, lang)}
            role={entry.data.role}
            company={entry.data.company}
            icon={entry.data.icon || 'work'}
            alignment={index % 2 === 0 ? 'left' : 'right'}
            nodeType={index === 0 ? 'present' : 'past'}
        >
            <entry.Content />
        </TimelineItem>
      ))}

      <!-- ACADEMIC ORIGIN DIVIDER -->
      <AcademicOrigin title={content.sections.academic} />

      <!-- Education Entries -->
      {education.map((entry, index) => (
         <TimelineItem
            year={dateRange(entry.data.dateStart, entry.data.dateEnd, lang)}
            role={entry.data.degree}
            company={entry.data.institution}
            icon={entry.data.icon || 'school'}
            alignment={index % 2 === 0 ? 'left' : 'right'}
            nodeType="past"
        >
            <entry.Content />
        </TimelineItem>
      ))}

    </div>

    <!-- Skills Section -->
    <SkillMatrix skills={uniqueSkills} title={content.sections.skills} />


</PageLayout>
